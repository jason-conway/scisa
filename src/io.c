#include "io.h"

void xhexdump(const void *src, size_t len)
{
    static const char hex[] = "0123456789abcdef";

    //              offset                        bytes                             ascii
    //            00000000  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
    char row[] = "--------  -- -- -- -- -- -- -- --  -- -- -- -- -- -- -- --  |----------------|";
    //                      ^  ^  ^  ^  ^  ^  ^  ^   ^  ^  ^  ^  ^  ^  ^  ^    ^
    //                     10 13 16 19 22 25 28 31  35 38 41 44 47 50 53 56   61

    static const uint8_t map[] = {
        10, 61, 13, 62, 16, 63, 19, 64,
        22, 65, 25, 66, 28, 67, 31, 68,
        35, 69, 38, 70, 41, 71, 44, 72,
        47, 73, 50, 74, 53, 75, 56, 76
    };

    static const char ascii_table[] = {
        0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e,
        0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e,
        0x20, 0x21, 0x22, 0x23, 0x24, 0x25, 0x26, 0x27, 0x28, 0x29, 0x2a, 0x2b, 0x2c, 0x2d, 0x2e, 0x2f,
        0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x3a, 0x3b, 0x3c, 0x3d, 0x3e, 0x3f,
        0x40, 0x41, 0x42, 0x43, 0x44, 0x45, 0x46, 0x47, 0x48, 0x49, 0x4a, 0x4b, 0x4c, 0x4d, 0x4e, 0x4f,
        0x50, 0x51, 0x52, 0x53, 0x54, 0x55, 0x56, 0x57, 0x58, 0x59, 0x5a, 0x5b, 0x5c, 0x5d, 0x5e, 0x5f,
        0x60, 0x61, 0x62, 0x63, 0x64, 0x65, 0x66, 0x67, 0x68, 0x69, 0x6a, 0x6b, 0x6c, 0x6d, 0x6e, 0x6f,
        0x70, 0x71, 0x72, 0x73, 0x74, 0x75, 0x76, 0x77, 0x78, 0x79, 0x7a, 0x7b, 0x7c, 0x7d, 0x7e, 0x2e,
        0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e,
        0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e,
        0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e,
        0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e,
        0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e,
        0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e,
        0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e,
        0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e
    };

    const uint8_t *mem = src;

    for (size_t offset = 0;; offset += 16) {
        size_t line_len = ((len - offset) > 16) ? 16 : len - offset;
        if (!line_len) {
            break;
        }

        uint8_t line[16] = { 0 };
        for (size_t i = 0; i < line_len; i++) {
            line[i] = mem[offset + i];
        }

        // Offset
        for (size_t i = 0; i < 8; i++) {
            row[i] = hex[(offset >> (28 - 4 * i)) & 0xf];
        }

        for (size_t i = 0; i < 16; i++) {
            // Hex
            row[map[2 * i] + 0] = hex[line[i] >> 4];
            row[map[2 * i] + 1] = hex[line[i] & 15];

            // ASCII
            row[map[2 * i + 1]] = ascii_table[line[i]];
        }

        // Clear on last loop
        for (size_t i = line_len; i < 16; i++) {
            // Hex
            row[map[2 * i] + 0] = 0x20;
            row[map[2 * i] + 1] = 0x20;

            // ASCII
            row[map[2 * i + 1]] = 0x20;
        }

        fprintf(stderr, "\033[33m%s\033[0m\n", row);

        if (line_len != 16) {
            break;
        }
    }
}

void flush_output(output_t *o)
{
    if (!o->err && o->len) {
        o->err = !os_write(o->fd, o->data, o->len);
        o->len = 0;
    }
}

void print_str(output_t *o, str_t s)
{
    uint8_t *c = &s.data[0];
    uint8_t *end = &s.data[s.len];
    while (c < end && !o->err) {
        ptrdiff_t avail = o->cap - o->len;
        uint8_t *dst = &o->data[o->len];

        ptrdiff_t i = 0;
        ptrdiff_t j = 0;

        while (i < end - c && j < avail) {
            const uint8_t e = c[i];
            if (unlikely(!e)) {
                flush_output(o);
                i++;
                c += i;
                goto next;
            }
            dst[j++] = e;
            i++;
        }

        c += i;
        o->len += j;
        if (o->len == o->cap) {
            flush_output(o);
        }
next:;
    }
}
